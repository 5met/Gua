<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>易经起卦</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- 64卦背景 -->
    <div class="hexagram-background" id="hexagramBackground"></div>

    <!-- 主容器 -->
    <div class="container">
        <!-- 提问框卡片 -->
        <div class="liquidGlass-wrapper question-container">
            <div class="liquidGlass-effect"></div>
            <div class="liquidGlass-tint"></div>
            <div class="liquidGlass-shine"></div>
            <div class="liquidGlass-text">
                <!-- 输入区域 -->
                <div class="input-with-button">
                    <input type="text" id="questionInput" class="question-input" placeholder="请输入您的问题...">
                    <button id="sendBtn" class="btn btn-primary">起卦</button>
                </div>

                <!-- 结果显示区域（折叠在提问框内） -->
                <div class="result-container" id="resultContainer">
                    <div class="result-divider"></div>
                    <div class="hexagram-display">
                        <div class="hexagram-image" id="hexagramImage"></div>
                        <div class="hexagram-info">
                            <div class="hexagram-name" id="hexagramName"></div>
                            <div class="hexagram-description" id="hexagramDescription"></div>
                        </div>
                    </div>
                    <div class="ai-interpretation">
                        <div class="ai-interpretation-title">AI解卦</div>
                        <div class="ai-interpretation-content" id="aiInterpretationContent"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 64卦数据 - 根据周易六十四卦列表
        // 卦象使用六爻表示法：☰乾(天) ☷坤(地) ☵坎(水) ☲离(火) ☳震(雷) ☴巽(风) ☶艮(山) ☱兑(泽)
        const hexagrams = [
            // 上经30卦
            { name: '乾', fullName: '乾为天', symbol: '䷀', lines: '☰☰', description: '元亨利貞' },
            { name: '坤', fullName: '坤为地', symbol: '䷁', lines: '☷☷', description: '元亨，利牝馬之貞' },
            { name: '屯', fullName: '水雷屯', symbol: '䷂', lines: '☵☳', description: '元亨利貞，勿用有攸往' },
            { name: '蒙', fullName: '山水蒙', symbol: '䷃', lines: '☶☵', description: '亨，匪我求童蒙，童蒙求我' },
            { name: '需', fullName: '水天需', symbol: '䷄', lines: '☵☰', description: '有孚，光亨貞吉' },
            { name: '讼', fullName: '天水讼', symbol: '䷅', lines: '☰☵', description: '有孚，窒惕，中吉，終凶' },
            { name: '师', fullName: '地水师', symbol: '䷆', lines: '☷☵', description: '貞丈人吉，无咎' },
            { name: '比', fullName: '水地比', symbol: '䷇', lines: '☵☷', description: '吉，原筮，元永貞，无咎' },
            { name: '小畜', fullName: '风天小畜', symbol: '䷈', lines: '☴☰', description: '亨，密雲不雨，自我西郊' },
            { name: '履', fullName: '天泽履', symbol: '䷉', lines: '☰☱', description: '履虎尾，不咥人，亨' },
            { name: '泰', fullName: '地天泰', symbol: '䷊', lines: '☷☰', description: '小往大來，吉亨' },
            { name: '否', fullName: '天地否', symbol: '䷋', lines: '☰☷', description: '否之匪人，不利君子貞' },
            { name: '同人', fullName: '天火同人', symbol: '䷌', lines: '☰☲', description: '同人于野，亨' },
            { name: '大有', fullName: '火天大有', symbol: '䷍', lines: '☲☰', description: '元亨' },
            { name: '谦', fullName: '地山谦', symbol: '䷎', lines: '☷☶', description: '亨，君子有終' },
            { name: '豫', fullName: '雷地豫', symbol: '䷏', lines: '☳☷', description: '利建侯行師' },
            { name: '随', fullName: '泽雷随', symbol: '䷐', lines: '☱☳', description: '元亨利貞，无咎' },
            { name: '蛊', fullName: '山风蛊', symbol: '䷑', lines: '☶☴', description: '元亨，利涉大川' },
            { name: '临', fullName: '地泽临', symbol: '䷒', lines: '☷☱', description: '元亨利貞，至于八月有凶' },
            { name: '观', fullName: '风地观', symbol: '䷓', lines: '☴☷', description: '盥而不薦，有孚顒若' },
            { name: '噬嗑', fullName: '火雷噬嗑', symbol: '䷔', lines: '☲☳', description: '亨，利用獄' },
            { name: '贲', fullName: '山火贲', symbol: '䷕', lines: '☶☲', description: '亨，小利有攸往' },
            { name: '剥', fullName: '山地剥', symbol: '䷖', lines: '☶☷', description: '不利有攸往' },
            { name: '复', fullName: '地雷复', symbol: '䷗', lines: '☷☳', description: '亨，出入无疾，朋來无咎' },
            { name: '无妄', fullName: '天雷无妄', symbol: '䷘', lines: '☰☳', description: '元亨利貞，其匪正有眚' },
            { name: '大畜', fullName: '山天大畜', symbol: '䷙', lines: '☶☰', description: '利貞，不家食吉' },
            { name: '颐', fullName: '山雷颐', symbol: '䷚', lines: '☶☳', description: '貞吉，觀頤，自求口實' },
            { name: '大过', fullName: '泽风大过', symbol: '䷛', lines: '☱☴', description: '棟橈，利有攸往，亨' },
            { name: '坎', fullName: '坎为水', symbol: '䷜', lines: '☵☵', description: '習坎，有孚維心亨' },
            { name: '离', fullName: '离为火', symbol: '䷝', lines: '☲☲', description: '利貞亨，畜牝牛吉' },
            // 下经34卦
            { name: '咸', fullName: '泽山咸', symbol: '䷞', lines: '☱☶', description: '亨利貞，取女吉' },
            { name: '恒', fullName: '雷风恒', symbol: '䷟', lines: '☳☴', description: '亨无咎，利貞，利有攸往' },
            { name: '遁', fullName: '天山遁', symbol: '䷠', lines: '☰☶', description: '亨，小利貞' },
            { name: '大壮', fullName: '雷天大壮', symbol: '䷡', lines: '☳☰', description: '利貞' },
            { name: '晋', fullName: '火地晋', symbol: '䷢', lines: '☲☷', description: '康侯用錫馬蕃庶' },
            { name: '明夷', fullName: '地火明夷', symbol: '䷣', lines: '☷☲', description: '利艱貞' },
            { name: '家人', fullName: '风火家人', symbol: '䷤', lines: '☴☲', description: '利女貞' },
            { name: '睽', fullName: '火泽睽', symbol: '䷥', lines: '☲☱', description: '小事吉' },
            { name: '蹇', fullName: '水山蹇', symbol: '䷦', lines: '☵☶', description: '利西南，不利東北' },
            { name: '解', fullName: '雷水解', symbol: '䷧', lines: '☳☵', description: '利西南，无所往，其來復吉' },
            { name: '损', fullName: '山泽损', symbol: '䷨', lines: '☶☱', description: '有孚，元吉，无咎' },
            { name: '益', fullName: '风雷益', symbol: '䷩', lines: '☴☳', description: '利有攸往，利涉大川' },
            { name: '夬', fullName: '泽天夬', symbol: '䷪', lines: '☱☰', description: '揚于王庭，孚號有厲' },
            { name: '姤', fullName: '天风姤', symbol: '䷫', lines: '☰☴', description: '女壯，勿用取女' },
            { name: '萃', fullName: '泽地萃', symbol: '䷬', lines: '☱☷', description: '亨，王假有廟' },
            { name: '升', fullName: '地风升', symbol: '䷭', lines: '☷☴', description: '元亨，用見大人' },
            { name: '困', fullName: '泽水困', symbol: '䷮', lines: '☱☵', description: '亨貞，大人吉，无咎' },
            { name: '井', fullName: '水风井', symbol: '䷯', lines: '☵☴', description: '改邑不改井，无喪无得' },
            { name: '革', fullName: '泽火革', symbol: '䷰', lines: '☱☲', description: '己日乃孚，元亨利貞' },
            { name: '鼎', fullName: '火风鼎', symbol: '䷱', lines: '☲☴', description: '元吉亨' },
            { name: '震', fullName: '震为雷', symbol: '䷲', lines: '☳☳', description: '亨，震來虩虩' },
            { name: '艮', fullName: '艮为山', symbol: '䷳', lines: '☶☶', description: '艮其背，不獲其身' },
            { name: '渐', fullName: '风山渐', symbol: '䷴', lines: '☴☶', description: '女歸吉，利貞' },
            { name: '归妹', fullName: '雷泽归妹', symbol: '䷵', lines: '☳☱', description: '征凶，无攸利' },
            { name: '丰', fullName: '雷火丰', symbol: '䷶', lines: '☳☲', description: '亨，王假之' },
            { name: '旅', fullName: '火山旅', symbol: '䷷', lines: '☲☶', description: '小亨，旅貞吉' },
            { name: '巽', fullName: '巽为风', symbol: '䷸', lines: '☴☴', description: '小亨，利有攸往' },
            { name: '兑', fullName: '兑为泽', symbol: '䷹', lines: '☱☱', description: '亨利貞' },
            { name: '涣', fullName: '风水涣', symbol: '䷺', lines: '☴☵', description: '亨，王假有廟' },
            { name: '节', fullName: '水泽节', symbol: '䷻', lines: '☵☱', description: '亨，苦節不可貞' },
            { name: '中孚', fullName: '风泽中孚', symbol: '䷼', lines: '☴☱', description: '豚魚吉，利涉大川' },
            { name: '小过', fullName: '雷山小过', symbol: '䷽', lines: '☳☶', description: '亨利貞，可小事' },
            { name: '既济', fullName: '水火既济', symbol: '䷾', lines: '☵☲', description: '亨小，利貞' },
            { name: '未济', fullName: '火水未济', symbol: '䷿', lines: '☲☵', description: '亨，小狐汔濟' }
        ];

        // DOM元素
        const questionInput = document.getElementById('questionInput');
        const sendBtn = document.getElementById('sendBtn');
        const resultContainer = document.getElementById('resultContainer');
        const hexagramImage = document.getElementById('hexagramImage');
        const hexagramName = document.getElementById('hexagramName');
        const hexagramDescription = document.getElementById('hexagramDescription');
        const hexagramBackground = document.getElementById('hexagramBackground');
        const aiInterpretationContent = document.getElementById('aiInterpretationContent');

        // API配置
        let apiKey = 'sk-jitntevrbtbglohuhxidentnldaxkwvwpcwptlbgchodcbhc';
        let currentQuestion = '';
        let currentHexagram = null;
        let flashingInterval = null;

        // 创建64卦背景 - 随机铺满屏幕
        function createHexagramBackground() {
            hexagramBackground.innerHTML = '';
            
            // 计算屏幕尺寸
            const screenWidth = window.innerWidth;
            const screenHeight = window.innerHeight;
            
            // 计算需要的卦象数量（铺满屏幕，增加密度）
            const itemSize = 90;
            const cols = Math.ceil(screenWidth / itemSize) + 2;
            const rows = Math.ceil(screenHeight / itemSize) + 2;
            const totalItems = cols * rows;
            
            // 创建卦象数组，循环使用64卦直到铺满屏幕
            const hexagramArray = [];
            for (let i = 0; i < totalItems; i++) {
                hexagramArray.push(hexagrams[i % 64]);
            }
            
            // 随机打乱数组
            for (let i = hexagramArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [hexagramArray[i], hexagramArray[j]] = [hexagramArray[j], hexagramArray[i]];
            }
            
            // 创建卦象元素
            for (let i = 0; i < totalItems; i++) {
                const hexagramItem = document.createElement('div');
                hexagramItem.className = 'hexagram-item';
                
                // 随机位置（带一些偏移让布局不那么规则）
                const colIndex = i % cols;
                const rowIndex = Math.floor(i / cols);
                const x = colIndex * itemSize + Math.random() * 30 - 15;
                const y = rowIndex * itemSize + Math.random() * 30 - 15;
                
                hexagramItem.style.left = x + 'px';
                hexagramItem.style.top = y + 'px';
                
                // 随机旋转角度
                const rotation = Math.random() * 360;
                hexagramItem.style.transform = `rotate(${rotation}deg)`;
                
                // 随机透明度
                const opacity = 0.2 + Math.random() * 0.3;
                hexagramItem.style.opacity = opacity;
                
                // 随机字体大小
                const fontSize = 36 + Math.random() * 24;
                hexagramItem.style.fontSize = fontSize + 'px';
                
                // 设置六爻卦象符号
                hexagramItem.textContent = hexagramArray[i].symbol;
                // 添加悬停提示，显示完整卦名
                hexagramItem.title = `${hexagramArray[i].name}卦 · ${hexagramArray[i].fullName}`;
                
                hexagramBackground.appendChild(hexagramItem);
            }
        }

        // 开始背景闪烁效果
        function startFlashing() {
            const items = document.querySelectorAll('.hexagram-item');
            flashingInterval = setInterval(() => {
                // 随机选择一些卦进行闪烁
                items.forEach(item => {
                    if (Math.random() < 0.3) {
                        item.classList.add('flashing');
                    } else {
                        item.classList.remove('flashing');
                    }
                });
            }, 200);
        }

        // 停止背景闪烁效果
        function stopFlashing() {
            if (flashingInterval) {
                clearInterval(flashingInterval);
                flashingInterval = null;
                const items = document.querySelectorAll('.hexagram-item');
                items.forEach(item => {
                    item.classList.remove('flashing');
                });
            }
        }

        // 随机选择一个卦象（不显示）
        function selectRandomHexagram() {
            const randomIndex = Math.floor(Math.random() * hexagrams.length);
            return hexagrams[randomIndex];
        }

        // 显示卦象和AI解卦结果
        function showResult(hexagram, aiResult) {
            // 停止背景闪烁
            stopFlashing();
            
            // 填充卦象信息
            hexagramImage.textContent = hexagram.symbol;
            hexagramName.textContent = `${hexagram.name}卦 · ${hexagram.fullName}`;
            hexagramDescription.textContent = hexagram.description;
            
            // 填充AI解卦结果
            aiInterpretationContent.textContent = aiResult;
            
            // 显示结果容器
            resultContainer.classList.add('show');
            
            // 移动端：添加has-result类使容器顶部对齐
            document.querySelector('.container').classList.add('has-result');
            
            // 重新启用按钮
            sendBtn.disabled = false;
            sendBtn.textContent = '起卦';
        }

        // 调用AI进行解卦
        async function getAIInterpretation(question, hexagram) {
            try {
                const prompt = `你是一位精通易经的起卦大师。有人问："${question}"，抽到了${hexagram.fullName}（${hexagram.name}卦）。

卦辞：${hexagram.description}

请按以下结构回答（严格控制在150字以内）：
1. 第一段（50字左右）：用通俗语言解释这个卦的核心含义
2. 第二段（100字左右）：针对用户的问题给出分析和建议

要求：
- 语言要通俗易懂，像朋友聊天
- 不要用"根据卦象"等套话
- 直接、实用、有针对性

直接开始回答：`;

                const response = await fetch('https://api.siliconflow.cn/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'Qwen/Qwen3-8B',
                        messages: [
                            {
                                role: 'user',
                                content: prompt
                            }
                        ],
                        temperature: 0.7,
                        max_tokens: 300
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || '请求失败');
                }

                const data = await response.json();
                return data.choices[0].message.content;
            } catch (error) {
                console.error('AI解卦错误:', error);
                return `AI解卦遇到了一些问题：${error.message}\n\n不过不用担心，您抽到的"${hexagram.fullName}"本身就蕴含深意。建议您可以参考卦辞，结合自己的情况进行思考。如需重试，请刷新页面后重新起卦。`;
            }
        }

        // 重置结果
        function resetResult() {
            resultContainer.classList.remove('show');
            document.querySelector('.container').classList.remove('has-result');
            aiInterpretationContent.textContent = '';
            hexagramImage.textContent = '';
            hexagramName.textContent = '';
            hexagramDescription.textContent = '';
        }

        // 事件监听
        sendBtn.addEventListener('click', async function() {
            const question = questionInput.value.trim();
            if (!question) {
                alert('请输入您的问题');
                return;
            }

            // 保存当前问题
            currentQuestion = question;

            // 禁用按钮
            sendBtn.disabled = true;
            sendBtn.textContent = '解卦中...';

            // 重置结果
            resetResult();

            // 立即随机选择一个卦象（不显示）
            const selectedHexagram = selectRandomHexagram();
            currentHexagram = selectedHexagram;

            // 开始背景闪烁动画
            startFlashing();

            // 在AI解卦内容区域显示加载动画（提前准备结果容器但不显示）
            aiInterpretationContent.innerHTML = '<div class="ai-loading"><div class="loading-spinner"></div></div>';

            // 调用AI进行解卦（异步，等待结果）
            const aiResult = await getAIInterpretation(question, selectedHexagram);

            // AI完成后，显示卦象和解卦结果
            showResult(selectedHexagram, aiResult);
        });

        // 回车键发送
        questionInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendBtn.click();
            }
        });

        // 窗口大小变化时重新布局
        window.addEventListener('resize', function() {
            createHexagramBackground();
        });

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            createHexagramBackground();
        });
    </script>

    <!-- SVG滤镜：液态玻璃扭曲效果 -->
    <svg style="display: none">
        <filter
            id="glass-distortion"
            x="0%"
            y="0%"
            width="100%"
            height="100%"
            filterUnits="objectBoundingBox"
        >
            <feTurbulence
                type="fractalNoise"
                baseFrequency="0.01 0.01"
                numOctaves="1"
                seed="5"
                result="turbulence"
            />

            <feComponentTransfer in="turbulence" result="mapped">
                <feFuncR type="gamma" amplitude="1" exponent="10" offset="0.5" />
                <feFuncG type="gamma" amplitude="0" exponent="1" offset="0" />
                <feFuncB type="gamma" amplitude="0" exponent="1" offset="0.5" />
            </feComponentTransfer>

            <feGaussianBlur in="turbulence" stdDeviation="3" result="softMap" />

            <feSpecularLighting
                in="softMap"
                surfaceScale="5"
                specularConstant="1"
                specularExponent="100"
                lighting-color="white"
                result="specLight"
            >
                <fePointLight x="-200" y="-200" z="300" />
            </feSpecularLighting>

            <feComposite
                in="specLight"
                operator="arithmetic"
                k1="0"
                k2="1"
                k3="1"
                k4="0"
                result="litImage"
            />

            <feDisplacementMap
                in="SourceGraphic"
                in2="softMap"
                scale="150"
                xChannelSelector="R"
                yChannelSelector="G"
            />
        </filter>
    </svg>
</body>
</html>
